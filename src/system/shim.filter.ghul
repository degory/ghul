namespace Shim is
    use Collections;

    class FILTER[T]: System.Object, Iterable[T] is
        _iterable: Iterable[T];
        _predicate: (T) -> bool;

        iterator: Iterator[T] => new FILTER_ITERATOR[T](_iterable.iterator, _predicate);
        
        init(iterable: Iterable[T], predicate: (T) -> bool) is
            _iterable = iterable;
            _predicate = predicate;
        si

        init(iterable: Iterable[T]) is
            _iterable = iterable;
        si
    si

    class FILTER_ITERATOR[T]: Iterator[T] is
        _iterator: Iterator[T];
        _predicate: (T) -> bool;

        @IL.name.read("get_Current")
        current: T;

        init(iterator: Iterator[T], predicate: (T) -> bool) is
            _iterator = iterator;
            _predicate = predicate;

            assert _iterator?;
            assert _predicate?;
        si
        
        @IL.name("MoveNext")
        move_next() -> bool is
            // Console.write_line("FILTER: move next");

            while _iterator.move_next() do
                // Console.write_line("FILTER: inner move next");

                if _predicate(_iterator.current) then
                    // Console.write_line("FILTER: predicate passes");

                    current = _iterator.current;

                    // Console.write_line("FILTER: current: " + current + ", return true");

                    return true;
                fi

                // Console.write_line("FILTER: loop again");
            od

            // Console.write_line("FILTER: move next: return false");
            
            return false;
        si
    si

si
