namespace Driver is
    use System.Exception;
    use System.Threading.Tasks;

    class PASS_TASK is
        pass: Pass;
        source: SOURCE_FILE;
        task: Task;

        init(pass: Pass, source: SOURCE_FILE) is
            self.pass = pass;
            self.source = source;
        si
        
        start() is
            if pass.is_task_safe then
                IO.Std.error.write_line("start task for: " + pass + " over " + source);
                task = Task.run(() -> void is
                    execute();
                si);
            else
                execute();
            fi
        si

        execute() is
            try
                if pass.is_task_safe then
                    IO.Std.error.write_line("execute: " + pass + " over " + source);                    
                fi
                
                pass.apply(source);
                
                if pass.is_task_safe then
                    IO.Std.error.write_line("executed: " + pass + " over " + source);
                fi
            catch e: Exception
                IoC.CONTAINER.instance.logger.exception(source.definition.location, e, "caught exception running pass " + pass + " on source file " + source);
            yrt            
        si

        wait() is            
            if task? then
                IO.Std.error.write_line("wait for: " + pass + " over " + source);
                task.wait();
                IO.Std.error.write_line("complete: " + pass + " over " + source);
            fi
        si
    si
si
